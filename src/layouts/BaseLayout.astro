---
import Nav from '../components/Nav.astro';
import Footer from '../components/Footer.astro';
import '../styles/global.css';

interface Props {
  title: string;
  description?: string;
  ogTitle?: string;
  ogDescription?: string;
  ogType?: string;
  twitterCard?: string;
  canonicalPath?: string;
  currentPage?: string;
}

const {
  title,
  description,
  ogTitle,
  ogDescription,
  ogType = 'website',
  twitterCard,
  canonicalPath,
  currentPage = '',
} = Astro.props;

const siteUrl = 'https://vocabmaster.nhatbui.link';
const canonicalUrl = canonicalPath ? `${siteUrl}${canonicalPath}` : undefined;
const allowIndexing = import.meta.env.PUBLIC_ALLOW_INDEXING === 'true';
const gaMeasurementId = import.meta.env.PUBLIC_GA_MEASUREMENT_ID;
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{title}</title>
  {!allowIndexing && <meta name="robots" content="noindex, nofollow" />}
  {description && <meta name="description" content={description} />}
  {ogTitle && <meta property="og:title" content={ogTitle} />}
  {ogDescription && <meta property="og:description" content={ogDescription} />}
  <meta property="og:type" content={ogType} />
  {twitterCard && <meta name="twitter:card" content={twitterCard} />}
  {twitterCard && ogTitle && <meta name="twitter:title" content={ogTitle} />}
  {twitterCard && ogDescription && <meta name="twitter:description" content={ogDescription} />}
  {canonicalUrl && <link rel="canonical" href={canonicalUrl} />}
  <link rel="icon" type="image/png" sizes="192x192" href="/logo192.png" />
  <link rel="apple-touch-icon" href="/logo192.png" />
  {gaMeasurementId && (
    <>
      <script async src={`https://www.googletagmanager.com/gtag/js?id=${gaMeasurementId}`}></script>
      <script define:vars={{ gaMeasurementId }}>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', gaMeasurementId, { anonymize_ip: true });
      </script>
    </>
  )}
</head>
<body>
  <Nav currentPage={currentPage} />

  <main>
    <slot />
  </main>

  <Footer />

  <script>
    // --- Mobile Navigation Toggle ---
    const navToggle = document.getElementById('navToggle');
    const navLinks = document.getElementById('navLinks');

    if (navToggle && navLinks) {
      navToggle.addEventListener('click', function () {
        navToggle.classList.toggle('active');
        navLinks.classList.toggle('active');
      });

      navLinks.querySelectorAll('a').forEach(function (link) {
        link.addEventListener('click', function () {
          navToggle.classList.remove('active');
          navLinks.classList.remove('active');
        });
      });
    }

    // --- Smooth Scroll for Anchor Links ---
    document.querySelectorAll('a[href^="#"]').forEach(function (anchor) {
      anchor.addEventListener('click', function (e) {
        const targetId = this.getAttribute('href');
        if (targetId === '#') return;

        const target = document.querySelector(targetId!);
        if (target) {
          e.preventDefault();
          const navEl = document.querySelector('.nav');
          const navHeight = navEl ? navEl.offsetHeight : 0;
          const targetPosition = target.getBoundingClientRect().top + window.pageYOffset - navHeight;
          window.scrollTo({
            top: targetPosition,
            behavior: 'smooth'
          });
        }
      });
    });

    // --- Scroll-triggered Fade-in Animations ---
    const fadeElements = document.querySelectorAll('.fade-in');

    if (fadeElements.length > 0 && 'IntersectionObserver' in window) {
      const observer = new IntersectionObserver(function (entries) {
        entries.forEach(function (entry) {
          if (entry.isIntersecting) {
            entry.target.classList.add('visible');
            observer.unobserve(entry.target);
          }
        });
      }, {
        threshold: 0.15,
        rootMargin: '0px 0px -40px 0px'
      });

      fadeElements.forEach(function (el) {
        observer.observe(el);
      });
    } else {
      fadeElements.forEach(function (el) {
        el.classList.add('visible');
      });
    }

    // --- GA4 CTA Click Tracking ---
    if (typeof gtag === 'function') {
      document.querySelectorAll('[data-ga-cta]').forEach(function (el) {
        el.addEventListener('click', function () {
          gtag('event', 'cta_click', {
            cta_name: el.getAttribute('data-ga-cta'),
            cta_location: el.getAttribute('data-ga-location') || '',
            link_url: el.getAttribute('href') || '',
          });
        });
      });
    }
  </script>
</body>
</html>
